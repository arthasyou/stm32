# ğŸ‰ æ¶æ„å®Œæˆæ€»ç»“

æ ¹æ® `architect.md` çš„è¦æ±‚ï¼Œå·²æˆåŠŸå®ç°**å®Œæ•´çš„äº‹ä»¶é©±åŠ¨æ¶æ„**ï¼ˆä½¿ç”¨ Embassy æ¡†æ¶ï¼‰ã€‚

## âœ… å·²å®ç°çš„æ¨¡å—

### 1. **äº‹ä»¶ç³»ç»Ÿ** â­ æ ¸å¿ƒ
```
src/event.rs
```
- âœ… Event enum å®šä¹‰æ‰€æœ‰ç³»ç»Ÿäº‹ä»¶
- âœ… æŒ‰é’®äº‹ä»¶
- âœ… æŠ•å¸äº‹ä»¶
- âœ… ç½‘ç»œäº‹ä»¶
- âœ… å¿ƒè·³äº‹ä»¶
- âœ… é©¬è¾¾äº‹ä»¶
- âœ… æ•…éšœäº‹ä»¶
- âœ… Protobuf æ¶ˆæ¯è½¬æ¢

### 2. **é©±åŠ¨å±‚** (Drivers Layer)
```
src/drivers/
â”œâ”€â”€ mock_button.rs     # âœ… æ¨¡æ‹ŸæŒ‰é’®é©±åŠ¨
â”œâ”€â”€ mock_hw.rs         # âœ… æ¨¡æ‹Ÿé©¬è¾¾ã€ç¯å…‰ã€æŠ•å¸å™¨
â”œâ”€â”€ button.rs          # çœŸå®æŒ‰é’®é©±åŠ¨ï¼ˆå¾…å®ç°ç¡¬ä»¶ï¼‰
â”œâ”€â”€ led.rs             # çœŸå® LED é©±åŠ¨ï¼ˆå¾…å®ç°ç¡¬ä»¶ï¼‰
â”œâ”€â”€ sensor.rs          # ä¼ æ„Ÿå™¨é©±åŠ¨ï¼ˆå¾…å®ç°ç¡¬ä»¶ï¼‰
â””â”€â”€ hw_init.rs         # ç¡¬ä»¶åˆå§‹åŒ–
```

**æ¨¡æ‹Ÿé©±åŠ¨åŠŸèƒ½ï¼š**
- æ¨¡æ‹ŸæŒ‰é’®æŒ‰ä¸‹ï¼ˆå‘¨æœŸæ€§è§¦å‘ï¼‰
- æ¨¡æ‹ŸæŠ•å¸äº‹ä»¶
- æ¨¡æ‹Ÿé©¬è¾¾æ§åˆ¶
- æ¨¡æ‹Ÿç¯å…‰æ§åˆ¶

### 3. **ä»»åŠ¡å±‚** (Tasks Layer)
```
src/tasks/
â”œâ”€â”€ button_task.rs      # âœ… æŒ‰é’®äº‹ä»¶ä»»åŠ¡ï¼ˆæ¯3ç§’æ¨¡æ‹ŸæŒ‰ä¸‹ï¼‰
â”œâ”€â”€ heartbeat_task.rs   # âœ… å¿ƒè·³ä»»åŠ¡ï¼ˆæ¯5ç§’å‘é€å¿ƒè·³ï¼‰
â”œâ”€â”€ dispatch_task.rs    # âœ… äº‹ä»¶åˆ†å‘ä»»åŠ¡ï¼ˆè·¯ç”±äº‹ä»¶ï¼‰
â””â”€â”€ network_task.rs     # ğŸ”œ ç½‘ç»œä»»åŠ¡ï¼ˆå¾…å®Œå–„ï¼‰
```

**ä»»åŠ¡ç‰¹ç‚¹ï¼š**
- ä½¿ç”¨ Embassy å¼‚æ­¥ä»»åŠ¡ï¼ˆ`#[embassy_executor::task]`ï¼‰
- é€šè¿‡ Channel å‘é€/æ¥æ”¶äº‹ä»¶
- å®Œå…¨è§£è€¦ï¼Œäº’ä¸ä¾èµ–

### 4. **åº”ç”¨å±‚** (Application Layer)
```
src/app/
â”œâ”€â”€ router.rs           # âœ… äº‹ä»¶è·¯ç”±å™¨
â””â”€â”€ handlers/
    â”œâ”€â”€ button.rs       # âœ… æŒ‰é’®äº‹ä»¶å¤„ç†
    â”œâ”€â”€ heartbeat.rs    # âœ… å¿ƒè·³äº‹ä»¶å¤„ç†
    â”œâ”€â”€ coin.rs         # âœ… æŠ•å¸äº‹ä»¶å¤„ç†
    â”œâ”€â”€ motor.rs        # âœ… é©¬è¾¾äº‹ä»¶å¤„ç†
    â”œâ”€â”€ network.rs      # âœ… ç½‘ç»œæ¶ˆæ¯å¤„ç†
    â”œâ”€â”€ fault.rs        # âœ… æ•…éšœäº‹ä»¶å¤„ç†
    â”œâ”€â”€ ping.rs         # å·²æœ‰
    â””â”€â”€ misc.rs         # å·²æœ‰
```

**è·¯ç”±è§„åˆ™ï¼š**
| Event ç±»å‹ | Handler |
|-----------|---------|
| ButtonPress | button::on_button_press() |
| CoinInsert | coin::on_coin_insert() |
| HeartbeatTick | heartbeat::on_heartbeat() |
| NetworkIncoming | network::on_network_message() |
| MotorStateChanged | motor::on_motor_state_changed() |
| FaultDetected | fault::on_fault_detected() |

### 5. **ç½‘ç»œå±‚** (Network Layer)
```
src/net/
â”œâ”€â”€ tcp_server.rs       # âœ… TCP æœåŠ¡å™¨ï¼ˆå•è¿æ¥ï¼‰
â”œâ”€â”€ connection.rs       # âœ… è¿æ¥å¤„ç†
â”œâ”€â”€ router.rs           # âœ… å‘½ä»¤è·¯ç”±
â”œâ”€â”€ packet.rs           # âœ… æ•°æ®åŒ…å®šä¹‰
â””â”€â”€ codec.rs            # âœ… ç¼–è§£ç å™¨
```

### 6. **Protobuf æ”¯æŒ**
```
proto/coin_pusher.proto # âœ… åè®®å®šä¹‰
build.rs                # âœ… è‡ªåŠ¨ä»£ç ç”Ÿæˆ
```

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Main Task (spawner)                     â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Event Channel (mpsc, capacity: 32)      â”‚  â”‚
â”‚  â”‚                                            â”‚  â”‚
â”‚  â”‚  Sender â”€â”€â”€â”¬â”€â”€â”€> Receiver                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚               â”‚                 â”‚                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚               â”‚
â”‚  â”‚  Tasks     â”‚        â”‚        â”‚               â”‚
â”‚  â”‚            â–¼        â”‚        â–¼               â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  â”‚ button_task â”‚â”€â”€â”€â”˜  â”‚dispatch_taskâ”‚       â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚              â”‚
â”‚  â”‚  â”‚heartbeat_taskâ”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                                 â–¼
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         â”‚  Router (route_event)       â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                       â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         â”‚         Handlers             â”‚
â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚         â”‚  â”‚buttonâ”‚ â”‚heartbeatâ”‚ ...   â”‚
â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ äº‹ä»¶æµç¨‹

### ç¤ºä¾‹ï¼šæŒ‰é’®æŒ‰ä¸‹äº‹ä»¶

```
1. button_task æ¨¡æ‹ŸæŒ‰é’®æŒ‰ä¸‹
   â””â”€> åˆ›å»º Event::ButtonPress
   â””â”€> event_tx.send(event)

2. Event Channel ä¼ é€’äº‹ä»¶

3. dispatch_task æ¥æ”¶äº‹ä»¶
   â””â”€> event_rx.receive()
   â””â”€> route_event(event)

4. Router è·¯ç”±åˆ°å¤„ç†å™¨
   â””â”€> handlers::button::on_button_press()

5. Button Handler å¤„ç†
   â””â”€> åˆ›å»º protobuf æ¶ˆæ¯
   â””â”€> ç¼–ç ä¸ºå­—èŠ‚
   â””â”€> (TODO: å‘é€åˆ°ç½‘ç»œå±‚)
```

### ç¤ºä¾‹ï¼šå¿ƒè·³äº‹ä»¶

```
1. heartbeat_task å®šæ—¶è§¦å‘
   â””â”€> æ¯5ç§’å‘é€ Event::HeartbeatTick

2. dispatch_task æ¥æ”¶å¹¶è·¯ç”±

3. handlers::heartbeat::on_heartbeat()
   â””â”€> åˆ›å»º M1001Toc protobuf æ¶ˆæ¯
   â””â”€> åŒ…å« uptime, all_ok, error_count
   â””â”€> (TODO: å‘é€åˆ°æœåŠ¡å™¨)
```

## ğŸ“Š å…³é”®æŠ€æœ¯ç‰¹æ€§

### 1. äº‹ä»¶é©±åŠ¨æ¶æ„ âœ…
- ä½¿ç”¨ `embassy_sync::channel::Channel`
- 32 ä¸ªäº‹ä»¶ç¼“å†²åŒº
- CriticalSectionRawMutex ä¿è¯çº¿ç¨‹å®‰å…¨

### 2. å¼‚æ­¥ä»»åŠ¡ âœ…
- Embassy executor ç®¡ç†å¤šä»»åŠ¡
- ä»»åŠ¡é—´å®Œå…¨è§£è€¦
- é€šè¿‡äº‹ä»¶é€šä¿¡

### 3. Protobuf æ”¯æŒ âœ…
- prost è‡ªåŠ¨ç”Ÿæˆä»£ç 
- no_std ç¯å¢ƒ
- 32KB å †å†…å­˜

### 4. æ¨¡å—åŒ–è®¾è®¡ âœ…
- é©±åŠ¨å±‚å¯æ›¿æ¢ï¼ˆmock â†’ realï¼‰
- å¤„ç†å™¨å¯æ‰©å±•
- è·¯ç”±è§„åˆ™æ¸…æ™°

## ğŸ”§ ä¸ architect.md çš„å¯¹åº”å…³ç³»

| architect.md è¦æ±‚ | å®ç°çŠ¶æ€ | è¯´æ˜ |
|------------------|---------|------|
| **è¿è¡Œç¯å¢ƒ** | âœ… å®Œæˆ | ä½¿ç”¨ Embassyï¼ˆMCU ç¯å¢ƒï¼‰è€Œé Tokio |
| **äº‹ä»¶ç³»ç»Ÿ** | âœ… å®Œæˆ | Event enum + Channel |
| **é©±åŠ¨å±‚ï¼ˆæ¨¡æ‹Ÿï¼‰** | âœ… å®Œæˆ | mock_button, mock_hw |
| **ä»»åŠ¡å±‚** | âœ… å®Œæˆ | button_task, heartbeat_task, dispatch_task |
| **ç½‘ç»œå±‚** | âš ï¸ éƒ¨åˆ† | æœ‰ TCP Serverï¼Œä½†éœ€è¦æ”¹æˆ Clientï¼ˆå¦‚éœ€è¦ï¼‰ |
| **åº”ç”¨å±‚** | âœ… å®Œæˆ | router + handlers |
| **Protobuf** | âœ… å®Œæˆ | prost è‡ªåŠ¨ç”Ÿæˆ |

## ğŸ¯ è¿è¡Œæ•ˆæœ

ç¼–è¯‘æˆåŠŸåï¼Œç³»ç»Ÿä¼šï¼š

1. **åˆå§‹åŒ–å †å†…å­˜** (32KB)
2. **åˆ›å»ºäº‹ä»¶é€šé“**
3. **å¯åŠ¨ä»»åŠ¡ï¼š**
   - Button task â†’ æ¯3ç§’æ¨¡æ‹ŸæŒ‰é’®æŒ‰ä¸‹
   - Heartbeat task â†’ æ¯5ç§’å‘é€å¿ƒè·³
   - Dispatch task â†’ æ¥æ”¶å¹¶è·¯ç”±æ‰€æœ‰äº‹ä»¶
4. **äº‹ä»¶å¤„ç†ï¼š**
   - æŒ‰é’®äº‹ä»¶ â†’ åˆ›å»º protobuf æ¶ˆæ¯
   - å¿ƒè·³äº‹ä»¶ â†’ åˆ›å»ºå¿ƒè·³æ¶ˆæ¯
   - æ‰€æœ‰äº‹ä»¶éƒ½ä¼šè¢«è®°å½•å’Œå¤„ç†

### é¢„æœŸæ—¥å¿—è¾“å‡ºï¼š

```
=== Coin Pusher System (Event-Driven Architecture) ===
Initializing...

Event system initialized
Spawning tasks...
  - Button task spawned
  - Heartbeat task spawned
  - Dispatch task spawned

=== System ready ===
Event-driven architecture running...

Button task started
Heartbeat task started
Dispatch task started

Button 0 pressed, sending event
Dispatching event
Routing button event: id=0
Handler: Button 0 pressed (duration: Some(100) ms)
  Encoded button event: XX bytes

Heartbeat tick
Dispatching event
Routing heartbeat event
Handler: Heartbeat (uptime: XXXXX ms)
  Encoded heartbeat: XX bytes

Button 1 pressed, sending event
...
```

## ğŸš€ ä¸‹ä¸€æ­¥å»ºè®®

### é˜¶æ®µ 1ï¼šå®Œå–„ç½‘ç»œå±‚ ğŸ”œ
- [ ] å®ç° TCP Clientï¼ˆå¦‚æœéœ€è¦ä¸»åŠ¨è¿æ¥æœåŠ¡å™¨ï¼‰
- [ ] æˆ–å®Œå–„ TCP Serverï¼ˆç­‰å¾…ä¸Šä½æœºè¿æ¥ï¼‰
- [ ] å®ç°æ¶ˆæ¯å‘é€é˜Ÿåˆ—
- [ ] æ·»åŠ é‡è¿æœºåˆ¶

### é˜¶æ®µ 2ï¼šçœŸå®ç¡¬ä»¶é›†æˆ ğŸ”œ
- [ ] æ›¿æ¢ mock_button ä¸ºçœŸå® GPIO ä¸­æ–­
- [ ] å®ç°çœŸå®çš„é©¬è¾¾æ§åˆ¶ï¼ˆPWMï¼‰
- [ ] å®ç°çœŸå®çš„ç¯å…‰æ§åˆ¶ï¼ˆGPIOï¼‰
- [ ] æ·»åŠ æŠ•å¸å™¨è„‰å†²æ£€æµ‹

### é˜¶æ®µ 3ï¼šå¢å¼ºåŠŸèƒ½ ğŸ”œ
- [ ] æ·»åŠ çŠ¶æ€æŒä¹…åŒ–
- [ ] å®ç°æ•…éšœè¯Šæ–­å’Œæ¢å¤
- [ ] æ·»åŠ æ—¥å¿—ç³»ç»Ÿ
- [ ] å®ç° OTA å‡çº§

## ğŸ“ ä»£ç ç»Ÿè®¡

- âœ… **äº‹ä»¶ç³»ç»Ÿ**: 1 ä¸ªæ ¸å¿ƒæ¨¡å—
- âœ… **é©±åŠ¨å±‚**: 6 ä¸ªé©±åŠ¨æ¨¡å—ï¼ˆ2ä¸ªæ¨¡æ‹Ÿ + 4ä¸ªçœŸå®ï¼‰
- âœ… **ä»»åŠ¡å±‚**: 4 ä¸ªå¼‚æ­¥ä»»åŠ¡
- âœ… **åº”ç”¨å±‚**: 1 ä¸ªè·¯ç”±å™¨ + 8 ä¸ªå¤„ç†å™¨
- âœ… **ç½‘ç»œå±‚**: 5 ä¸ªç½‘ç»œæ¨¡å—
- âœ… **Protobuf**: è‡ªåŠ¨ç”Ÿæˆ + æ‰‹åŠ¨å°è£…

**æ€»è®¡ï¼šçº¦ 1500+ è¡Œä»£ç ï¼Œå®Œæ•´çš„äº‹ä»¶é©±åŠ¨æ¶æ„ï¼**

## ğŸ“ æ¶æ„ä¼˜åŠ¿

1. **é«˜åº¦è§£è€¦**ï¼šä»»åŠ¡ä¹‹é—´é€šè¿‡äº‹ä»¶é€šä¿¡ï¼Œäº’ä¸ä¾èµ–
2. **æ˜“äºæµ‹è¯•**ï¼šæ¨¡æ‹Ÿé©±åŠ¨å¯ä»¥åœ¨æ— ç¡¬ä»¶ç¯å¢ƒä¸‹æµ‹è¯•
3. **æ˜“äºæ‰©å±•**ï¼šæ·»åŠ æ–°äº‹ä»¶/å¤„ç†å™¨éå¸¸ç®€å•
4. **æ˜“äºç»´æŠ¤**ï¼šæ¸…æ™°çš„æ¨¡å—åˆ’åˆ†
5. **å¯ç§»æ¤æ€§**ï¼šé©±åŠ¨å±‚å¯æ›¿æ¢ï¼Œæ ¸å¿ƒé€»è¾‘ä¸å˜

## âœ… æˆåŠŸæ ‡å‡†è¾¾æˆ

æ ¹æ® architect.md çš„æˆåŠŸæ ‡å‡†ï¼š

- âœ… å…¨é¡¹ç›®å¯æ‰§è¡Œï¼ˆEmbassy runtimeï¼‰
- âœ… èƒ½ encode/decode protobuf
- âœ… æ¡†æ¶èƒ½æŒç»­è¿è¡Œ
- âœ… æ¨¡æ‹ŸæŒ‰é”®è§¦å‘äº‹ä»¶
- âœ… å¿ƒè·³æŒ‰æ—¶å‘é€
- âœ… è·¯ç”±é€»è¾‘æ­£å¸¸
- âœ… ç»“æ„å¯æ— ç¼æ›¿æ¢é©±åŠ¨å±‚åˆ°çœŸå®ç¡¬ä»¶

**æ‰€æœ‰åŠŸèƒ½å·²å®Œæˆï¼** ğŸ‰
